# Настройка Telegram Mini App

## Что нужно для запуска

Чтобы приложение работало с индивидуальными данными каждого пользователя Telegram, вам нужно создать Telegram бота и подключить к нему ваше Mini App.

## Шаг 1: Создание Telegram бота

1. Откройте Telegram и найдите бота **@BotFather**
2. Отправьте команду `/newbot`
3. Следуйте инструкциям:
   - Введите название бота (например, "GeoQuest Bot")
   - Введите username бота (должен заканчиваться на `bot`, например, `geoquest_walk_bot`)
4. Сохраните **Bot Token**, который выдаст BotFather

## Шаг 2: Создание Mini App

1. В чате с @BotFather отправьте команду `/newapp`
2. Выберите вашего бота из списка
3. Введите название приложения (например, "GeoQuest")
4. Введите описание приложения
5. Загрузите иконку (квадратное изображение 640x640px)
6. Загрузите GIF-превью (опционально)
7. **ВАЖНО:** Когда попросят Web App URL, введите:
   ```
   https://[ваш-replit-домен].replit.dev
   ```
   Или после публикации (Deploy) используйте ваш production URL

## Шаг 3: Получение URL Replit

### Вариант 1: Development URL (для тестирования)
1. В Replit нажмите кнопку "Run"
2. Скопируйте URL из адресной строки webview
3. Используйте этот URL в настройках Mini App

### Вариант 2: Production URL (рекомендуется)
1. Нажмите кнопку **"Deploy"** в правом верхнем углу Replit
2. Следуйте процессу деплоя
3. Получите production URL
4. Используйте этот URL в настройках Mini App

## Шаг 4: Настройка бота

1. В чате с @BotFather отправьте `/mybots`
2. Выберите вашего бота
3. Настройте:
   - **Menu Button** - привяжите ваше Mini App
   - **Inline Mode** (опционально) - для встроенных запросов
   - **Description** - описание бота
   - **About** - краткая информация
   - **Bot Picture** - аватар бота

## Шаг 5: Запуск приложения

После настройки:

1. Найдите вашего бота в Telegram
2. Нажмите `/start` или кнопку "Menu"
3. Приложение откроется с вашими личными данными!

## Что происходит при первом запуске

При первом входе пользователя через Telegram бота:

1. ✅ Telegram передаёт данные пользователя (ID, имя, фото)
2. ✅ Приложение автоматически создаёт профиль в базе данных
3. ✅ Пользователь начинает с 0 очков и уровнем 1
4. ✅ Все дальнейшие прогресс сохраняется автоматически

## Тестирование в Replit

⚠️ **Важно:** В Replit webview preview приложение показывает заглушку "Загрузка...", потому что там нет данных Telegram.

Чтобы протестировать полную функциональность:
1. Настройте бота (шаги выше)
2. Откройте приложение через Telegram бота
3. Там все данные будут работать правильно

## Структура данных пользователя

Каждый пользователь Telegram автоматически получает:
- **ID** - уникальный ID в базе данных
- **Telegram ID** - ID пользователя из Telegram
- **Имя** - имя и фамилия из Telegram
- **Аватар** - фото профиля (если доступно)
- **Роль** - "traveler" по умолчанию
- **Очки** - начинается с 0
- **Уровень** - начинается с 1

## Безопасность

⚠️ **ВАЖНО ДЛЯ PRODUCTION:**

Текущая реализация подходит для MVP и тестирования, но для полноценного продакшна **требуется** добавить серверную валидацию Telegram данных:

### Что нужно добавить:

1. **Валидация HMAC подписи** на бэкенде:
   - Telegram передаёт подпись в `initData`
   - Сервер должен проверить HMAC-SHA256 с использованием Bot Token
   - Только после проверки создавать/возвращать пользователя

2. **Проверка auth_date**:
   - Убедиться что данные не старше 24 часов
   - Предотвратить replay-атаки

### Текущая реализация (MVP):

Приложение использует Telegram WebApp API для аутентификации:
- ✅ Данные передаются через защищённый канал Telegram
- ✅ Каждый пользователь видит только свои данные
- ⚠️ Нет серверной валидации подписи (добавьте для production)
- ✅ Для запуска через Telegram бота - безопасно
- ⚠️ При прямом доступе к URL - возможно создание фейковых пользователей

### Рекомендации:

- Для тестирования и MVP - текущая версия работает отлично
- Для production с реальными пользователями - добавьте серверную валидацию
- См. [Telegram Bot API - Validating data](https://core.telegram.org/bots/webapps#validating-data-received-via-the-mini-app)

## Дополнительные возможности

После настройки бота вы можете:

- Отправлять уведомления пользователям
- Использовать inline режим
- Добавить команды бота (например, `/help`, `/stats`)
- Настроить автоматические сообщения

## Полезные ссылки

- [Документация Telegram Mini Apps](https://core.telegram.org/bots/webapps)
- [BotFather - создание ботов](https://t.me/BotFather)
- [Telegram Bot API](https://core.telegram.org/bots/api)

## Поддержка

Если возникли проблемы:

1. Убедитесь что URL правильный и приложение запущено (Deploy)
2. Проверьте что Mini App привязан к боту через BotFather
3. Попробуйте перезапустить бота командой `/start`
4. Проверьте консоль браузера на ошибки (в настоящем Telegram, не в Replit)
